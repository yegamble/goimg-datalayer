# Penetration Testing Plan - goimg-datalayer

**Version:** 1.0
**Date:** 2025-12-05
**Prepared by:** Senior Security Operations Engineer
**Project:** goimg-datalayer - Image Gallery Backend
**Status:** Draft

---

## Executive Summary

This document outlines the penetration testing methodology, scope, and schedule for the goimg-datalayer project prior to production launch. The testing will validate security controls, identify vulnerabilities, and ensure compliance with security best practices for a multi-user image hosting platform.

## 1. Scope

### 1.1 In-Scope Components

#### Application Layer
- **Authentication System**
  - JWT token generation/validation (RS256)
  - Token blacklist mechanism (Redis)
  - Refresh token rotation with replay detection
  - Session management and multi-device support
  - Account lockout mechanisms

- **Authorization System**
  - Role-based access control (RBAC): user, moderator, admin
  - Resource ownership validation
  - Horizontal/vertical privilege escalation paths
  - Permission boundaries for image/album/comment operations

- **API Endpoints** (All `/api/v1/*`)
  - Authentication: `/auth/*` (register, login, refresh, logout)
  - User Management: `/users/*`
  - Image Operations: `/images/*`
  - Album Management: `/albums/*`
  - Social Features: `/images/{id}/likes`, `/images/{id}/comments`
  - Public Endpoints: `/explore/*`

- **File Upload System**
  - Multipart form data handling
  - File type validation (MIME type checking)
  - Image processing pipeline (bimg/libvips)
  - Malware scanning (ClamAV integration)
  - Storage providers (Local, S3)

- **Security Middleware**
  - Security headers (CSP, X-Frame-Options, HSTS, etc.)
  - CORS configuration
  - Request timeout handling
  - Panic recovery mechanisms

#### Infrastructure Layer
- **Database Security**
  - PostgreSQL connection security
  - SQL injection vulnerability assessment
  - Sensitive data exposure in database errors

- **Cache/Session Store**
  - Redis authentication
  - Session fixation/hijacking tests
  - Token blacklist bypass attempts

- **Third-Party Integrations**
  - ClamAV malware scanning
  - AWS S3 storage security (if configured)

### 1.2 Out-of-Scope

- **Physical Security**: Data center security, hardware access controls
- **Network Infrastructure**: Firewall rules, VPN configuration, DDoS protection
- **Operating System**: Host OS vulnerabilities, kernel exploits
- **Container Security**: Docker runtime vulnerabilities (separate assessment required)
- **Denial of Service**: Full-scale load testing (covered by performance testing)
- **Social Engineering**: Phishing attacks, pretexting
- **Source Code Supply Chain**: Dependency vulnerability scanning (covered by separate tooling)

### 1.3 Testing Constraints

- **Production Impact**: Testing will be performed in isolated development/staging environments only
- **Data Protection**: No real user data will be used; test data only
- **Time Windows**: Testing during business hours (9 AM - 6 PM EST)
- **Automated Tools**: Limited to non-destructive scanning tools
- **Destructive Tests**: Prohibited in any environment connected to production systems

---

## 2. Testing Methodology

### 2.1 Framework: OWASP Testing Guide v4.2

Testing will follow the OWASP Testing Guide methodology with specific focus on the OWASP Top 10 2021:

1. **A01:2021 – Broken Access Control**
   - IDOR (Insecure Direct Object Reference)
   - Missing function level access control
   - Horizontal/vertical privilege escalation
   - Forced browsing to authenticated endpoints

2. **A02:2021 – Cryptographic Failures**
   - Weak JWT signing algorithms (HS256 vs RS256)
   - Insecure token storage
   - Sensitive data in JWT payloads
   - Weak password hashing (bcrypt parameters)

3. **A03:2021 – Injection**
   - SQL injection via search/filter parameters
   - LDAP injection (if applicable)
   - OS command injection in filename handling
   - CRLF injection in HTTP headers

4. **A04:2021 – Insecure Design**
   - Account enumeration via registration/login
   - Missing rate limiting on authentication
   - Insecure password reset flow
   - Predictable session IDs

5. **A05:2021 – Security Misconfiguration**
   - Verbose error messages (stack traces)
   - Default credentials
   - Unnecessary HTTP methods enabled
   - Missing security headers

6. **A06:2021 – Vulnerable and Outdated Components**
   - Go version and stdlib CVEs
   - Third-party dependency vulnerabilities
   - Outdated ClamAV signatures

7. **A07:2021 – Identification and Authentication Failures**
   - Brute force attacks on login
   - Credential stuffing
   - Session fixation
   - Missing MFA/2FA

8. **A08:2021 – Software and Data Integrity Failures**
   - JWT signature validation bypass
   - Token replay attacks
   - Unsigned/unverified file uploads

9. **A09:2021 – Security Logging and Monitoring Failures**
   - Missing audit logs for security events
   - Insufficient logging detail
   - No alerting on suspicious activity

10. **A10:2021 – Server-Side Request Forgery (SSRF)**
    - SSRF via image URL import (if feature exists)
    - Internal service enumeration

### 2.2 Testing Phases

#### Phase 1: Information Gathering (4 hours)
- **Objective**: Map attack surface and identify entry points
- **Activities**:
  - Enumerate all API endpoints (OpenAPI spec review)
  - Review authentication flows (login, registration, password reset)
  - Identify user roles and permissions
  - Map file upload workflows
  - Document security headers and CORS policy

#### Phase 2: Automated Vulnerability Scanning (2 hours)
- **Objective**: Identify common vulnerabilities using automated tools
- **Tools**:
  - OWASP ZAP (passive + active scanning)
  - Burp Suite Community Edition (proxy traffic analysis)
  - `govulncheck` (Go vulnerability scanner)
  - Trivy (container image scanning)
  - gosec (static application security testing)

#### Phase 3: Manual Security Testing (16 hours)

**Authentication & Session Management (4 hours)**
- JWT token manipulation (algorithm confusion, signature bypass)
- Token expiration and refresh flow testing
- Session fixation and hijacking tests
- Account lockout bypass attempts
- Password reset token validation
- Multi-device session tracking

**Authorization & Access Control (4 hours)**
- IDOR testing on images, albums, comments
- Horizontal privilege escalation (user A accessing user B's resources)
- Vertical privilege escalation (user → moderator → admin)
- Parameter tampering (user_id, role modifications)
- Missing function-level access control

**Input Validation & Injection (3 hours)**
- SQL injection in search/filter parameters
- XSS in image metadata (title, description, tags)
- Command injection in filenames
- Path traversal in file uploads
- CRLF injection in headers

**File Upload Security (3 hours)**
- Polyglot file detection (GIF/JS combinations)
- SVG with embedded JavaScript
- EICAR test file (malware detection validation)
- Oversized file handling (DoS via memory exhaustion)
- Null byte injection in filenames
- Malicious image metadata (EXIF)

**Business Logic Flaws (2 hours)**
- Rate limiting bypass techniques
- Race conditions in like/comment operations
- Account enumeration via timing attacks
- Password complexity bypass

#### Phase 4: Exploit Development (4 hours)
- **Objective**: Develop proof-of-concept exploits for confirmed vulnerabilities
- **Activities**:
  - Create exploit scripts for high-severity findings
  - Document attack chains (multi-step exploits)
  - Validate impact and exploitability

#### Phase 5: Reporting (4 hours)
- **Objective**: Document findings with remediation guidance
- **Deliverables**:
  - Executive summary
  - Detailed vulnerability report (CVSS 3.1 scoring)
  - Proof-of-concept code/screenshots
  - Remediation recommendations with code examples
  - Retest plan

---

## 3. Tools and Technologies

### 3.1 Manual Testing Tools

| Tool | Purpose | License |
|------|---------|---------|
| Burp Suite Community | HTTP proxy, interceptor, repeater | Free |
| OWASP ZAP | Automated vulnerability scanner | Open Source |
| curl | API testing and request manipulation | Open Source |
| jq | JSON parsing and manipulation | Open Source |
| httpie | Human-friendly HTTP client | Open Source |
| Postman | API collection management and testing | Free |

### 3.2 Automated Testing Tools

| Tool | Purpose | Installation |
|------|---------|--------------|
| govulncheck | Go vulnerability scanner | `go install golang.org/x/vuln/cmd/govulncheck@latest` |
| gosec | Go security scanner (SAST) | `go install github.com/securego/gosec/v2/cmd/gosec@latest` |
| Trivy | Container/dependency scanner | `brew install trivy` |
| sqlmap | SQL injection automation | `pip install sqlmap` |
| nuclei | Template-based scanner | `go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest` |

### 3.3 Payload Collections

- **SecLists**: Common password lists, fuzzing payloads, injection strings
- **EICAR Test File**: Malware detection validation
- **SVG Payloads**: XSS vectors in SVG files
- **Polyglot Files**: Image files with embedded code

---

## 4. Test Scenarios

### 4.1 Authentication Testing

#### TC-AUTH-001: JWT Algorithm Confusion
**Description**: Attempt to change JWT algorithm from RS256 to HS256 to bypass signature validation.

**Steps**:
1. Capture valid JWT access token
2. Decode header and change `"alg": "RS256"` to `"alg": "HS256"`
3. Sign token with public key (treating it as symmetric key)
4. Submit modified token to protected endpoint

**Expected Result**: 401 Unauthorized (signature validation fails)

**Risk**: Critical - Complete authentication bypass if vulnerable

---

#### TC-AUTH-002: Token Replay After Logout
**Description**: Verify tokens are properly blacklisted after logout.

**Steps**:
1. Login and capture access token
2. Call `/api/v1/auth/logout` with token
3. Attempt to access protected endpoint with same token

**Expected Result**: 401 Unauthorized (token revoked message)

**Risk**: High - Session management bypass

---

#### TC-AUTH-003: Refresh Token Rotation Bypass
**Description**: Attempt to reuse old refresh tokens after rotation.

**Steps**:
1. Login and capture initial refresh token
2. Call `/api/v1/auth/refresh` to get new token pair
3. Attempt to use old refresh token again

**Expected Result**: 401 Unauthorized + entire token family revoked (replay detection)

**Risk**: High - Token theft exploitation

---

#### TC-AUTH-004: Account Enumeration via Timing
**Description**: Determine valid email addresses by measuring login response time.

**Steps**:
1. Attempt login with non-existent email (measure response time)
2. Attempt login with valid email + wrong password (measure response time)
3. Compare timing differences

**Expected Result**: No timing difference (constant-time comparison)

**Risk**: Medium - User enumeration enables targeted attacks

---

#### TC-AUTH-005: Brute Force Protection
**Description**: Validate account lockout after failed login attempts.

**Steps**:
1. Attempt login with wrong password 5 times
2. Observe lockout status
3. Attempt login with correct password during lockout
4. Wait for lockout expiry (15 minutes) and retry

**Expected Result**: Account locked after 5 attempts, unlocked after 15 minutes

**Risk**: High if missing - Credential brute-force attacks

---

### 4.2 Authorization Testing

#### TC-AUTHZ-001: IDOR on Image Retrieval
**Description**: Access another user's private images by manipulating image ID.

**Steps**:
1. Login as User A, upload private image, note image ID
2. Login as User B
3. Attempt `GET /api/v1/images/{user_a_image_id}`

**Expected Result**: 403 Forbidden (not owner) or 404 Not Found

**Risk**: Critical - Unauthorized data access

---

#### TC-AUTHZ-002: Image Deletion Across Users
**Description**: Delete another user's image.

**Steps**:
1. Login as User A, upload image, note ID
2. Login as User B
3. Send `DELETE /api/v1/images/{user_a_image_id}`

**Expected Result**: 403 Forbidden

**Risk**: Critical - Unauthorized data modification

---

#### TC-AUTHZ-003: Vertical Privilege Escalation
**Description**: Regular user attempts admin-only operations.

**Steps**:
1. Login as regular user
2. Attempt admin operations (if any, e.g., delete any user's images)
3. Attempt to change own role via parameter tampering

**Expected Result**: 403 Forbidden for all admin operations

**Risk**: Critical - Complete authorization bypass

---

#### TC-AUTHZ-004: Comment Ownership Validation
**Description**: Modify/delete another user's comment.

**Steps**:
1. User A adds comment on public image
2. User B attempts `DELETE /api/v1/comments/{user_a_comment_id}`

**Expected Result**: 403 Forbidden (only moderators/admins/owner can delete)

**Risk**: High - Unauthorized content modification

---

### 4.3 Injection Testing

#### TC-INJ-001: SQL Injection in Image Search
**Description**: Inject SQL payload in search query parameter.

**Steps**:
1. Send `GET /api/v1/images?q=' OR '1'='1`
2. Observe response for error messages or unexpected results
3. Try union-based injection: `?q=' UNION SELECT NULL, NULL--`

**Expected Result**: No SQL errors, parameterized queries prevent injection

**Risk**: Critical - Database compromise

---

#### TC-INJ-002: XSS in Image Metadata
**Description**: Inject JavaScript in image title/description.

**Steps**:
1. Upload image with title: `<script>alert('XSS')</script>`
2. Retrieve image metadata via API
3. Check if script is executed in client (if web UI exists)

**Expected Result**: Script tags escaped/sanitized in response

**Risk**: High - Stored XSS enables session hijacking

---

#### TC-INJ-003: Command Injection in Filenames
**Description**: Upload file with malicious filename.

**Steps**:
1. Upload file named: `image.jpg; ls -la`
2. Upload file named: `image.jpg\x00.php`
3. Upload file named: `../../../etc/passwd`

**Expected Result**: Filename sanitized, no command execution, no path traversal

**Risk**: Critical - Remote code execution or file system access

---

#### TC-INJ-004: CRLF Injection in Headers
**Description**: Inject CRLF in user-controlled header values.

**Steps**:
1. Send request with header: `User-Agent: curl/7.0\r\nX-Injected: true`
2. Check if injected header appears in response

**Expected Result**: CRLF characters stripped or escaped

**Risk**: Medium - HTTP response splitting, cache poisoning

---

### 4.4 File Upload Testing

#### TC-UPLOAD-001: Polyglot File (GIF+JavaScript)
**Description**: Upload polyglot file that is both valid GIF and executable script.

**Steps**:
1. Create file: `GIF89a/*<script>alert('XSS')</script>*/`
2. Upload via `/api/v1/images`
3. Access uploaded file directly

**Expected Result**: File rejected or re-encoded through bimg (strips embedded code)

**Risk**: High - XSS or code execution via direct file access

---

#### TC-UPLOAD-002: SVG with Embedded JavaScript
**Description**: Upload SVG with embedded script tags.

**Steps**:
1. Create SVG file:
```xml
<svg xmlns="http://www.w3.org/2000/svg">
  <script>alert('XSS')</script>
</svg>
```
2. Upload via API
3. Access file via variant endpoint

**Expected Result**: SVG rejected (not in allowed formats) or script stripped

**Risk**: High - Stored XSS

---

#### TC-UPLOAD-003: EICAR Malware Detection
**Description**: Validate ClamAV malware scanning.

**Steps**:
1. Upload file containing EICAR test signature:
```
X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
```
2. Observe response

**Expected Result**: 400 Bad Request with malware detected message

**Risk**: Critical if missing - Malware distribution via platform

---

#### TC-UPLOAD-004: Oversized File Upload
**Description**: Upload file exceeding size limits.

**Steps**:
1. Generate 100 MB file
2. Upload via API
3. Observe memory usage and response time

**Expected Result**: 413 Payload Too Large, no memory exhaustion

**Risk**: High - Denial of service via resource exhaustion

---

#### TC-UPLOAD-005: Null Byte Injection
**Description**: Upload file with null byte in filename to bypass extension validation.

**Steps**:
1. Upload file named: `malicious.php\x00.jpg`
2. Check stored filename on server

**Expected Result**: Filename sanitized, null bytes removed

**Risk**: High - Arbitrary file upload

---

### 4.5 Business Logic Testing

#### TC-LOGIC-001: Rate Limit Bypass
**Description**: Exceed rate limits using various techniques.

**Steps**:
1. Send 101 requests/minute to authenticated endpoint
2. Rotate user agents, IP addresses (if behind proxy)
3. Use multiple concurrent connections

**Expected Result**: 429 Too Many Requests after 100 requests

**Risk**: Medium - API abuse, resource exhaustion

---

#### TC-LOGIC-002: Race Condition in Likes
**Description**: Like the same image multiple times concurrently.

**Steps**:
1. Send 10 simultaneous `POST /api/v1/images/{id}/likes` requests
2. Check like count

**Expected Result**: Like count = 1 (idempotent operation)

**Risk**: Low - Data integrity issue

---

#### TC-LOGIC-003: Email Uniqueness Bypass
**Description**: Register multiple accounts with same email.

**Steps**:
1. Register user with `test@example.com`
2. Register user with `TEST@example.com` (case variation)
3. Register user with `test+alias@example.com` (plus addressing)

**Expected Result**: Only first registration succeeds (case-insensitive uniqueness)

**Risk**: Medium - Account enumeration, spam

---

---

## 5. Timeline and Schedule

| Phase | Duration | Start Date | End Date | Deliverable |
|-------|----------|------------|----------|-------------|
| **Planning & Scoping** | 2 hours | Day 1 AM | Day 1 AM | Test plan approval |
| **Phase 1: Information Gathering** | 4 hours | Day 1 PM | Day 1 PM | Attack surface map |
| **Phase 2: Automated Scanning** | 2 hours | Day 2 AM | Day 2 AM | Scan results |
| **Phase 3: Manual Testing** | 16 hours | Day 2 PM | Day 4 PM | Test execution logs |
| **Phase 4: Exploit Development** | 4 hours | Day 5 AM | Day 5 AM | PoC exploits |
| **Phase 5: Reporting** | 4 hours | Day 5 PM | Day 5 PM | Final report |
| **Total** | **32 hours** | **5 business days** |

---

## 6. Success Criteria

### 6.1 Completion Criteria
- [ ] All in-scope endpoints tested
- [ ] All OWASP Top 10 categories assessed
- [ ] All high/critical findings validated with PoC
- [ ] Remediation guidance provided for all findings
- [ ] Retest plan created for vulnerable areas

### 6.2 Security Baseline Requirements

**Must-Have Controls** (Launch Blockers):
- [ ] No Critical vulnerabilities (CVSS 9.0-10.0)
- [ ] No unauthenticated SQL injection
- [ ] No authentication bypass vulnerabilities
- [ ] No unauthorized data access (IDOR with Critical impact)
- [ ] Working malware scanning (EICAR detection)
- [ ] Account lockout after 5 failed attempts
- [ ] JWT signature validation cannot be bypassed
- [ ] Session tokens invalidated on logout

**Should-Have Controls** (Address Before Launch):
- [ ] No High vulnerabilities (CVSS 7.0-8.9) without compensating controls
- [ ] XSS vulnerabilities sanitized
- [ ] CSRF protection on state-changing operations
- [ ] Security headers properly configured
- [ ] Rate limiting on all authentication endpoints
- [ ] Audit logging for security events

**Nice-to-Have Controls** (Post-Launch Improvements):
- [ ] MFA/2FA support
- [ ] Advanced anomaly detection
- [ ] Geolocation-based access controls
- [ ] Security.txt file for vulnerability disclosure

---

## 7. Roles and Responsibilities

| Role | Name/Team | Responsibilities |
|------|-----------|------------------|
| **Penetration Tester** | Senior SecOps Engineer | Execute all testing phases, document findings |
| **Development Lead** | Backend Team | Provide technical context, answer questions |
| **Security Liaison** | DevSecOps | Coordinate access, approve test scope |
| **Incident Response** | On-Call Engineer | Available for critical finding escalation |
| **Project Manager** | Product Team | Track remediation timeline |

---

## 8. Reporting Structure

### 8.1 Finding Severity Classification (CVSS 3.1)

| Severity | CVSS Score | Example | SLA for Fix |
|----------|------------|---------|-------------|
| **Critical** | 9.0-10.0 | Unauthenticated RCE, SQL injection | 24 hours |
| **High** | 7.0-8.9 | Authenticated RCE, privilege escalation | 7 days |
| **Medium** | 4.0-6.9 | XSS, information disclosure | 30 days |
| **Low** | 0.1-3.9 | Security headers missing | 90 days |
| **Informational** | 0.0 | Best practice recommendations | Backlog |

### 8.2 Report Sections

1. **Executive Summary**
   - Overall security posture
   - Key findings (Critical/High only)
   - Risk summary
   - Recommendations

2. **Technical Details**
   - Vulnerability description
   - Affected component/endpoint
   - Proof of concept
   - CVSS score and vector
   - Impact analysis
   - Remediation steps

3. **Appendices**
   - Test execution logs
   - Raw scan results
   - Tool configurations
   - Payload collections used

---

## 9. Communication Plan

### 9.1 Status Updates
- **Daily Standup**: 15-minute sync during active testing
- **Slack Channel**: `#security-pentest`
- **Critical Findings**: Immediate escalation via phone/Slack

### 9.2 Escalation Path
1. **Critical Finding Discovered** → Notify Security Liaison immediately
2. **Production Impact Risk** → Stop testing, escalate to Incident Response
3. **Test Environment Issues** → Contact DevOps for resolution

### 9.3 Final Presentation
- **Audience**: Engineering leads, security team, product management
- **Duration**: 60 minutes
- **Format**: Slide deck + live demo of high-severity findings
- **Q&A**: 30 minutes

---

## 10. Risk and Mitigation

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Accidental production access | Critical | Low | Environment validation checklist before testing |
| Test data leakage | High | Low | Use synthetic test data only |
| Service disruption | Medium | Medium | Test during off-hours, coordinate with DevOps |
| False positives delay launch | Medium | High | Manual validation of all automated findings |
| Insufficient time for retesting | Medium | Medium | Prioritize Critical/High findings for retest |

---

## 11. Post-Testing Activities

### 11.1 Remediation Support
- Provide code review for security fixes
- Answer questions via Slack/email
- Validate fix effectiveness before production

### 11.2 Retesting
- Schedule retest within 14 days of fix implementation
- Focus on Critical/High findings
- Confirm no regression in related functionality

### 11.3 Continuous Improvement
- Integrate security tests into CI/CD pipeline
- Add E2E security tests for critical controls
- Update CLAUDE.md guides with security patterns

---

## 12. References

- [OWASP Testing Guide v4.2](https://owasp.org/www-project-web-security-testing-guide/)
- [OWASP Top 10 2021](https://owasp.org/Top10/)
- [OWASP API Security Top 10](https://owasp.org/www-project-api-security/)
- [NIST SP 800-115: Technical Guide to Information Security Testing](https://csrc.nist.gov/publications/detail/sp/800-115/final)
- [PTES: Penetration Testing Execution Standard](http://www.pentest-standard.org/)
- [CVE Database](https://cve.mitre.org/)
- [Go Vulnerability Database](https://vuln.go.dev/)

---

## Approval

| Role | Name | Signature | Date |
|------|------|-----------|------|
| **Security Lead** | | | |
| **Engineering Manager** | | | |
| **Product Owner** | | | |

---

**Document History**

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2025-12-05 | Senior SecOps Engineer | Initial draft |

