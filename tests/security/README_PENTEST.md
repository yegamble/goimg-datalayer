# Security Penetration Testing Scripts

This directory contains automated security testing scripts for the goimg-datalayer API. These scripts test for common vulnerabilities across authentication, authorization, injection, and file upload attack vectors.

## Quick Start

```bash
# Start the API server (required)
cd /home/user/goimg-datalayer
make run

# In a new terminal, run all security tests
cd tests/security
./run-all-tests.sh http://localhost:8080
```

## Test Suites

### 1. Authentication Security Tests
**Script:** `auth-security-tests.sh`
**Coverage:** JWT token security, session management, brute force protection

**Tests:**
- TC-AUTH-001: JWT Algorithm Confusion Attack
- TC-AUTH-002: Token Replay After Logout
- TC-AUTH-003: Refresh Token Rotation and Replay Detection
- TC-AUTH-004: Account Enumeration via Timing
- TC-AUTH-005: Account Lockout and Brute Force Protection
- TC-AUTH-006: Missing Authorization Header
- TC-AUTH-007: Malformed JWT Token Handling
- TC-AUTH-008: JWT Expiration Validation
- TC-AUTH-009: Email Case Sensitivity
- TC-AUTH-010: Password Complexity Enforcement

**Usage:**
```bash
./auth-security-tests.sh http://localhost:8080
```

**Expected Results:**
- All tests should PASS
- 0 Critical findings
- 0 High findings

---

### 2. Injection Vulnerability Tests
**Script:** `injection-tests.sh`
**Coverage:** SQL injection, XSS, command injection, path traversal

**Tests:**
- TC-INJ-001: SQL Injection in Image Search
- TC-INJ-002: SQL Injection in User Filter
- TC-INJ-003: Blind SQL Injection via Timing
- TC-INJ-004: Stored XSS in Image Metadata
- TC-INJ-005: Reflected XSS in Error Messages
- TC-INJ-006: Command Injection in Filename
- TC-INJ-007: Path Traversal in File Operations
- TC-INJ-008: CRLF Injection in Headers
- TC-INJ-009: Null Byte Injection
- TC-INJ-010: Server-Side Template Injection

**Usage:**
```bash
./injection-tests.sh http://localhost:8080
```

**Launch Blockers:**
- No SQL injection vulnerabilities (CVSS 10.0)
- No command injection (CVSS 10.0)
- No path traversal allowing file system access (CVSS 9.1)

---

### 3. File Upload Security Tests
**Script:** `upload-security-tests.sh`
**Coverage:** Malware detection, file type validation, resource limits

**Tests:**
- TC-UPLOAD-001: EICAR Malware Detection (ClamAV)
- TC-UPLOAD-002: Polyglot File (GIF + JavaScript)
- TC-UPLOAD-003: SVG with Embedded JavaScript
- TC-UPLOAD-004: Oversized File Upload (DoS)
- TC-UPLOAD-005: Double Extension Bypass
- TC-UPLOAD-006: Content-Type Mismatch
- TC-UPLOAD-007: Malicious EXIF Metadata
- TC-UPLOAD-008: Race Condition in Concurrent Uploads

**Usage:**
```bash
./upload-security-tests.sh http://localhost:8080
```

**Critical Tests:**
- EICAR detection MUST work (malware prevention)
- Oversized files MUST be rejected (DoS prevention)
- Polyglot files MUST be re-encoded (XSS prevention)

---

### 4. Access Control Tests
**Script:** `access-control-tests.sh`
**Coverage:** IDOR, privilege escalation, authorization bypass

**Tests:**
- TC-AUTHZ-001: IDOR on Private Image Retrieval
- TC-AUTHZ-002: IDOR on Image Deletion
- TC-AUTHZ-003: IDOR on Image Metadata Update
- TC-AUTHZ-004: Horizontal Privilege Escalation (User Profile)
- TC-AUTHZ-005: Vertical Privilege Escalation (Role Modification)
- TC-AUTHZ-006: Missing Function-Level Access Control
- TC-AUTHZ-007: JWT Token Manipulation (User ID Tampering)
- TC-AUTHZ-008: Like Bombing (Idempotency Check)
- TC-AUTHZ-009: Comment Deletion Authorization

**Usage:**
```bash
./access-control-tests.sh http://localhost:8080
```

**Launch Blockers:**
- No IDOR allowing access to private images (CVSS 9.1)
- No privilege escalation to admin role (CVSS 10.0)
- JWT signature validation CANNOT be bypassed (CVSS 10.0)

---

## Running All Tests

**Master Script:** `run-all-tests.sh`

```bash
#!/usr/bin/env bash
BASE_URL="${1:-http://localhost:8080}"

echo "Running Complete Security Test Suite"
echo "Target: $BASE_URL"
echo "========================================"

./auth-security-tests.sh "$BASE_URL"
./injection-tests.sh "$BASE_URL"
./upload-security-tests.sh "$BASE_URL"
./access-control-tests.sh "$BASE_URL"

echo "========================================"
echo "All Security Tests Complete"
echo "Review results in ./pentest-results/"
```

**Usage:**
```bash
chmod +x run-all-tests.sh
./run-all-tests.sh http://localhost:8080
```

---

## Test Results

Results are saved to `./pentest-results/` with timestamps:

```
pentest-results/
├── auth/
│   ├── critical_20251205_143022.log
│   ├── high_20251205_143022.log
│   └── failures_20251205_143022.log
├── injection/
│   ├── critical_20251205_143145.log
│   ├── sqli_evidence_1701792145.txt
│   └── ...
├── upload/
│   └── ...
└── access-control/
    └── idor_evidence_image_20251205_143300.json
```

**Log Format:**
```
[2025-12-05T14:30:22Z] CRITICAL: SQL Injection detected! Payload: ' OR '1'='1--
[2025-12-05T14:30:45Z] HIGH: IDOR VULNERABILITY: User B accessed User A's private image!
```

---

## Prerequisites

### Required Tools

All scripts require:
- `curl` - HTTP client
- `jq` - JSON processor
- `base64` - Base64 encoding/decoding
- `openssl` - Cryptographic operations (for auth tests)
- `dd` - Disk dump utility (for upload tests)

**Install on Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install -y curl jq openssl coreutils
```

**Install on macOS:**
```bash
brew install curl jq openssl coreutils
```

### API Server Requirements

- API must be running on specified BASE_URL
- Database must be accessible (PostgreSQL)
- Redis must be accessible (sessions, blacklist)
- ClamAV must be running (for malware detection tests)

**Verify API is ready:**
```bash
curl -s http://localhost:8080/health | jq .
# Should return: {"status": "ok"}
```

---

## Interpreting Results

### Exit Codes

- `0` - All tests passed, no security issues
- `1` - Critical or High severity findings detected

### Severity Levels

| Severity | CVSS Score | Exit Code | Action Required |
|----------|------------|-----------|-----------------|
| **CRITICAL** | 9.0-10.0 | 1 | Launch blocker - must fix immediately |
| **HIGH** | 7.0-8.9 | 1 | Fix before launch or document compensating controls |
| **MEDIUM** | 4.0-6.9 | 0 | Fix within 30 days post-launch |
| **LOW** | 0.1-3.9 | 0 | Backlog for future release |

### Success Criteria

✅ **Launch Ready:**
- 0 Critical findings
- 0 High findings (or documented compensating controls)
- All authentication tests pass
- EICAR malware detection works
- IDOR tests pass

⚠️ **Not Ready:**
- Any Critical findings
- High findings without mitigation
- Authentication bypass possible
- Malware scanning not working

---

## Customization

### Environment Variables

Scripts support environment variable overrides:

```bash
# Custom timeout for all curl commands
export CURL_TIMEOUT=60

# Skip certain test categories
export SKIP_SQL_INJECTION=true
export SKIP_XSS_TESTS=true

# Verbose logging
export DEBUG=true
```

### Test Configuration

Edit scripts to modify:
- Test user credentials
- Rate limit thresholds
- File size limits
- Timeout values

**Example:**
```bash
# In auth-security-tests.sh
TEST_USER_EMAIL="custom_email@example.com"
TEST_USER_PASSWORD="CustomP@ssw0rd!"
```

---

## Troubleshooting

### Tests Fail Immediately

**Symptom:** "ERROR: Failed to register test user"

**Solutions:**
1. Verify API is running: `curl http://localhost:8080/health`
2. Check database is accessible
3. Review API logs for errors
4. Ensure user registration is enabled

### EICAR Test Passes (Should Fail)

**Symptom:** TC-UPLOAD-001 shows PASS but EICAR file was accepted

**Solutions:**
1. Verify ClamAV is running: `docker ps | grep clamav`
2. Check ClamAV signatures are loaded: `docker logs clamav | grep "Virus database"`
3. Test ClamAV manually: `echo 'X5O!P%@...' | clamdscan -`
4. Review upload handler integration with malware scanner

### Permission Denied Errors

**Symptom:** "Permission denied" when running scripts

**Solution:**
```bash
chmod +x *.sh
```

### Network Timeout Errors

**Symptom:** "curl: (28) Operation timed out"

**Solutions:**
1. Increase timeout in script
2. Check API server is responsive
3. Verify no firewall blocking localhost connections

---

## Integration with CI/CD

### GitHub Actions Example

```yaml
name: Security Tests

on: [push, pull_request]

jobs:
  security-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      clamav:
        image: clamav/clamav:latest
        options: >-
          --health-cmd "clamdscan --ping 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 3

    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Build and run API
        run: |
          make build
          ./bin/api &
          sleep 5

      - name: Run security tests
        run: |
          cd tests/security
          ./run-all-tests.sh http://localhost:8080

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-test-results
          path: tests/security/pentest-results/
```

---

## Best Practices

### Before Running Tests

1. **Isolate test environment** - Never run against production
2. **Backup database** - Tests create/modify data
3. **Review test user credentials** - Avoid conflicts with real users
4. **Coordinate with team** - Notify others testing is in progress

### After Running Tests

1. **Review all logs** - Check `./pentest-results/` directory
2. **Document findings** - Use `/docs/security/pentest-findings-template.md`
3. **Create tickets** - For each finding, create a task
4. **Retest after fixes** - Verify vulnerabilities are resolved

### Regular Testing

- **Every commit:** Run in CI/CD (automated)
- **Before deploy:** Full manual test run
- **Monthly:** Review and update test cases
- **Quarterly:** External penetration test

---

## Support

For questions or issues:
- Review documentation: `/docs/security/`
- Check logs: `./pentest-results/`
- Contact security team: security@goimg.example.com

---

## References

- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
- [OWASP Top 10 2021](https://owasp.org/Top10/)
- [CWE Top 25](https://cwe.mitre.org/top25/)
- [NIST SP 800-115](https://csrc.nist.gov/publications/detail/sp/800-115/final)

---

**Last Updated:** 2025-12-05
**Version:** 1.0
**Maintainer:** Senior Security Operations Engineer
