name: Security Scanning

# Run security scans on pushes, PRs, and weekly schedule
on:
  push:
    branches:
      - main
      - develop
      - 'claude/*'
  pull_request:
    branches:
      - "**"
  schedule:
    # Run weekly on Mondays at 00:00 UTC to catch new vulnerabilities
    - cron: '0 0 * * 1'
  workflow_dispatch: # Allow manual triggering

# Ensure only one security scan runs at a time per branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.24.x"

jobs:
  # ============================================================================
  # GoSec - Go Security Analysis
  # Scans for common security issues in Go code
  # ============================================================================
  gosec:
    name: GoSec Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      # Only request security-events if needed (will gracefully fail on private repos)
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Set up Go
        uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5.0.2
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      # Install libvips for bimg package compilation
      - name: Install libvips
        run: |
          sudo apt-get update
          sudo apt-get install -y libvips-dev

      - name: Run gosec security scanner
        run: |
          # Install gosec
          go install github.com/securego/gosec/v2/cmd/gosec@latest

          # Run gosec and generate multiple output formats
          gosec -fmt json -out gosec-results.json -exclude-dir=tests -severity=medium ./... || GOSEC_EXIT=$?
          gosec -fmt sarif -out gosec-results.sarif -exclude-dir=tests -severity=medium ./... || true
          gosec -fmt text -exclude-dir=tests -severity=medium ./... 2>&1 | tee gosec-results.txt || true

          # Generate summary
          echo "## GoSec Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f gosec-results.json ]; then
            ISSUE_COUNT=$(jq '.Issues | length' gosec-results.json 2>/dev/null || echo "0")
            echo "**Issues Found:** ${ISSUE_COUNT}" >> $GITHUB_STEP_SUMMARY

            if [ "$ISSUE_COUNT" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Issues by Severity" >> $GITHUB_STEP_SUMMARY
              jq -r '.Issues | group_by(.severity) | .[] | "\(.[0].severity): \(length)"' gosec-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || true
            fi
          fi

          # Exit with original code if there were issues
          exit ${GOSEC_EXIT:-0}

      # Try to upload to Security tab (will fail silently on private repos without GHAS)
      - name: Upload gosec SARIF (if available)
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3.31.9
        if: always() && hashFiles('gosec-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: gosec-results.sarif
          category: gosec

      - name: Upload gosec results as artifact
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        if: always()
        with:
          name: gosec-results
          path: |
            gosec-results.json
            gosec-results.sarif
            gosec-results.txt
          retention-days: 30

  # ============================================================================
  # Trivy - Comprehensive Vulnerability Scanner
  # Scans for vulnerabilities in dependencies, filesystem, and configuration
  # ============================================================================
  trivy:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        scan-type:
          - fs        # Filesystem scan for dependencies
          - config    # Configuration file scan (Docker, K8s, etc.)

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Run Trivy ${{ matrix.scan-type }} scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: ${{ matrix.scan-type }}
          scan-ref: '.'
          format: 'table'
          output: 'trivy-${{ matrix.scan-type }}-results.txt'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true
          exit-code: '1'
        continue-on-error: true
        id: trivy-scan

      - name: Generate SARIF output
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: ${{ matrix.scan-type }}
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-${{ matrix.scan-type }}-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true
        continue-on-error: true

      - name: Add Trivy results to summary
        if: always()
        run: |
          echo "## Trivy ${{ matrix.scan-type }} Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "trivy-${{ matrix.scan-type }}-results.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat "trivy-${{ matrix.scan-type }}-results.txt" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No results generated" >> $GITHUB_STEP_SUMMARY
          fi

      # Try to upload to Security tab (will fail silently on private repos without GHAS)
      - name: Upload Trivy SARIF (if available)
        uses: github/codeql-action/upload-sarif@45c373516f557556c15d420e3f5e0aa3d64366bc # v3.31.9
        if: always() && hashFiles(format('trivy-{0}-results.sarif', matrix.scan-type)) != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-${{ matrix.scan-type }}-results.sarif'
          category: trivy-${{ matrix.scan-type }}

      - name: Upload Trivy results as artifact
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        if: always()
        with:
          name: trivy-${{ matrix.scan-type }}-results
          path: |
            trivy-${{ matrix.scan-type }}-results.txt
            trivy-${{ matrix.scan-type }}-results.sarif
          retention-days: 30

      - name: Fail if vulnerabilities found
        if: steps.trivy-scan.outcome == 'failure'
        run: |
          echo "Trivy found vulnerabilities. Check the results above."
          exit 1

  # ============================================================================
  # Govulncheck - Official Go Vulnerability Scanner
  # Scans Go code and dependencies for known vulnerabilities
  # ============================================================================
  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Set up Go
        uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5.0.2
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      # Install libvips for bimg package compilation
      - name: Install libvips
        run: |
          sudo apt-get update
          sudo apt-get install -y libvips-dev

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Download dependencies
        run: go mod download

      - name: Run govulncheck
        id: govulncheck
        run: |
          echo "## Go Vulnerability Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run govulncheck and capture output
          if govulncheck ./... 2>&1 | tee govulncheck-output.txt; then
            echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            echo "vulns_found=false" >> $GITHUB_OUTPUT
          else
            echo "Vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat govulncheck-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "vulns_found=true" >> $GITHUB_OUTPUT
          fi

          # Also generate JSON output for artifacts
          govulncheck -format json ./... > govulncheck-results.json 2>&1 || true

      - name: Upload govulncheck results
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        if: always()
        with:
          name: govulncheck-results
          path: |
            govulncheck-output.txt
            govulncheck-results.json
          retention-days: 30

      - name: Fail if vulnerabilities found
        if: steps.govulncheck.outputs.vulns_found == 'true'
        run: |
          echo "govulncheck found vulnerabilities. Check the results above."
          exit 1

  # ============================================================================
  # Secret Scanning - Detect accidentally committed secrets
  # ============================================================================
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks secret scanner
        id: gitleaks
        run: |
          echo "## Secret Detection Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if gitleaks detect --source . --report-format json --report-path gitleaks-results.json 2>&1 | tee gitleaks-output.txt; then
            echo "No secrets detected" >> $GITHUB_STEP_SUMMARY
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          else
            echo "**Potential secrets detected!**" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat gitleaks-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "secrets_found=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload Gitleaks results
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        if: always()
        with:
          name: gitleaks-results
          path: |
            gitleaks-results.json
            gitleaks-output.txt
          retention-days: 30
          if-no-files-found: ignore

      - name: Fail if secrets found
        if: steps.gitleaks.outputs.secrets_found == 'true'
        run: |
          echo "Gitleaks found potential secrets. Check the results above."
          exit 1

  # ============================================================================
  # Dependency Audit - Check for vulnerable or outdated dependencies
  # Works on all repositories (no GHAS required)
  # ============================================================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Set up Go
        uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5.0.2
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Check go.mod/go.sum
        run: |
          echo "## Dependency Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Module Verification" >> $GITHUB_STEP_SUMMARY
          if go mod verify; then
            echo "All modules verified successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "Module verification failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependency Check" >> $GITHUB_STEP_SUMMARY

          # Check for any issues with go mod tidy
          cp go.mod go.mod.backup
          cp go.sum go.sum.backup

          go mod tidy

          if ! diff -q go.mod go.mod.backup > /dev/null 2>&1 || ! diff -q go.sum go.sum.backup > /dev/null 2>&1; then
            echo "go.mod or go.sum is not tidy. Run 'go mod tidy' and commit changes." >> $GITHUB_STEP_SUMMARY
            mv go.mod.backup go.mod
            mv go.sum.backup go.sum
            exit 1
          fi

          echo "Dependencies are properly maintained" >> $GITHUB_STEP_SUMMARY
          rm -f go.mod.backup go.sum.backup

      - name: List direct dependencies
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Direct Dependencies" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go list -m -f '{{if not .Indirect}}{{.Path}} {{.Version}}{{end}}' all | grep -v "^$" | head -50 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # SBOM Generation - Software Bill of Materials
  # ============================================================================
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Set up Go
        uses: actions/setup-go@0a12ed9d6a96ab950c8f026ed9f722fe0da7ef32 # v5.0.2
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Generate SBOM with cyclonedx-gomod
        run: |
          go install github.com/CycloneDX/cyclonedx-gomod/cmd/cyclonedx-gomod@latest
          cyclonedx-gomod mod -json -output sbom.cdx.json

          echo "## SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Software Bill of Materials generated in CycloneDX format" >> $GITHUB_STEP_SUMMARY

          # Count components
          COMPONENT_COUNT=$(jq '.components | length' sbom.cdx.json 2>/dev/null || echo "0")
          echo "**Total Components:** ${COMPONENT_COUNT}" >> $GITHUB_STEP_SUMMARY

      - name: Upload SBOM
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: sbom
          path: sbom.cdx.json
          retention-days: 90

      - name: Scan SBOM with Grype
        run: |
          # Install Grype
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SBOM Vulnerability Scan (Grype)" >> $GITHUB_STEP_SUMMARY

          if grype sbom:sbom.cdx.json --fail-on high 2>&1 | tee grype-output.txt; then
            echo "No high/critical vulnerabilities found in SBOM" >> $GITHUB_STEP_SUMMARY
          else
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat grype-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Upload Grype results
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        if: always()
        with:
          name: grype-results
          path: grype-output.txt
          retention-days: 30
          if-no-files-found: ignore

  # ============================================================================
  # Security Summary - Aggregate results and post summary
  # ============================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [gosec, trivy, govulncheck, secret-scan, dependency-audit, sbom]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Check security scan results
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GoSec | ${{ needs.gosec.result == 'success' && 'PASS' || (needs.gosec.result == 'skipped' && 'SKIPPED' || 'FAIL') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | ${{ needs.trivy.result == 'success' && 'PASS' || (needs.trivy.result == 'skipped' && 'SKIPPED' || 'FAIL') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Govulncheck | ${{ needs.govulncheck.result == 'success' && 'PASS' || (needs.govulncheck.result == 'skipped' && 'SKIPPED' || 'FAIL') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result == 'success' && 'PASS' || (needs.secret-scan.result == 'skipped' && 'SKIPPED' || 'FAIL') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result == 'success' && 'PASS' || (needs.dependency-audit.result == 'skipped' && 'SKIPPED' || 'FAIL') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM | ${{ needs.sbom.result == 'success' && 'PASS' || (needs.sbom.result == 'skipped' && 'SKIPPED' || 'FAIL') }} |" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [[ "${{ needs.gosec.result }}" == "failure" ]] || \
             [[ "${{ needs.trivy.result }}" == "failure" ]] || \
             [[ "${{ needs.govulncheck.result }}" == "failure" ]] || \
             [[ "${{ needs.secret-scan.result }}" == "failure" ]] || \
             [[ "${{ needs.dependency-audit.result }}" == "failure" ]] || \
             [[ "${{ needs.sbom.result }}" == "failure" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**One or more security scans failed. Review the results above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**All security scans passed!**" >> $GITHUB_STEP_SUMMARY
