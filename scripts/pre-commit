#!/bin/bash
# Pre-commit hook for goimg-datalayer
# This hook enforces linting before each commit
#
# Installation: run 'make install-hooks' or 'scripts/setup-hooks.sh'
#
# This hook is MANDATORY for all contributors, including Claude agents.

set -e

echo "==> Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if pre-commit framework is installed and use it
if command -v pre-commit &> /dev/null; then
    echo "==> Using pre-commit framework..."
    pre-commit run --staged
    exit $?
fi

# Fallback: Run lint checks directly if pre-commit framework isn't available
echo -e "${YELLOW}Warning: pre-commit framework not installed, running manual checks${NC}"
echo "Install with: pip install pre-commit && pre-commit install"
echo ""

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo "No Go files staged for commit, skipping Go checks..."
else
    # Run go fmt
    echo "==> Running go fmt..."
    UNFORMATTED=$(gofmt -l $STAGED_GO_FILES 2>&1 || true)
    if [ -n "$UNFORMATTED" ]; then
        echo -e "${RED}ERROR: The following files are not formatted:${NC}"
        echo "$UNFORMATTED"
        echo ""
        echo "Run 'go fmt ./...' to fix formatting"
        exit 1
    fi
    echo -e "${GREEN}go fmt: OK${NC}"

    # Run go vet
    echo "==> Running go vet..."
    if ! go vet ./... 2>&1; then
        echo -e "${RED}ERROR: go vet found issues${NC}"
        exit 1
    fi
    echo -e "${GREEN}go vet: OK${NC}"

    # Run golangci-lint if available
    if command -v golangci-lint &> /dev/null; then
        echo "==> Running golangci-lint..."
        if ! golangci-lint run --new-from-rev=HEAD~1 2>&1; then
            echo -e "${RED}ERROR: golangci-lint found issues${NC}"
            echo ""
            echo "Fix linting issues or run 'golangci-lint run' for details"
            exit 1
        fi
        echo -e "${GREEN}golangci-lint: OK${NC}"
    else
        echo -e "${YELLOW}Warning: golangci-lint not installed, skipping...${NC}"
        echo "Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
    fi
fi

# Check for secrets in staged files (basic check)
echo "==> Checking for potential secrets..."
SECRETS_PATTERN='(password|secret|api_key|apikey|token|credential).*=.*["\x27][^"\x27]{8,}'
if git diff --cached --diff-filter=ACM | grep -iE "$SECRETS_PATTERN" > /dev/null 2>&1; then
    echo -e "${YELLOW}Warning: Potential secrets detected in staged changes${NC}"
    echo "Please review your changes and ensure no secrets are being committed"
fi

echo ""
echo -e "${GREEN}==> Pre-commit checks passed!${NC}"
exit 0
