version: "3.9"

# Production Docker Compose Configuration
# ========================================
# Security-hardened setup for production deployment
#
# Features:
# - Read-only root filesystems where possible
# - Non-root users for all services
# - Resource limits (CPU, memory)
# - Comprehensive health checks
# - Network isolation with internal network
# - Proper volume permissions
# - Security options (no-new-privileges, seccomp)

services:
  # ============================================================================
  # API Server
  # ============================================================================
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: goimg-api
    restart: unless-stopped
    user: "10001:10001"
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    environment:
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      DB_SSL_MODE: ${DB_SSL_MODE:-require}
      DB_MAX_OPEN_CONNS: ${DB_MAX_OPEN_CONNS:-25}
      DB_MAX_IDLE_CONNS: ${DB_MAX_IDLE_CONNS:-5}
      DB_CONN_MAX_LIFETIME: ${DB_CONN_MAX_LIFETIME:-5m}

      # Redis
      REDIS_URL: redis://redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: ${REDIS_DB:-0}
      REDIS_MAX_RETRIES: ${REDIS_MAX_RETRIES:-3}

      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-24h}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-168h}

      # API Settings
      API_PORT: 8080
      API_HOST: 0.0.0.0
      API_READ_TIMEOUT: ${API_READ_TIMEOUT:-30s}
      API_WRITE_TIMEOUT: ${API_WRITE_TIMEOUT:-30s}
      API_IDLE_TIMEOUT: ${API_IDLE_TIMEOUT:-120s}
      API_MAX_HEADER_BYTES: ${API_MAX_HEADER_BYTES:-1048576}

      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
      CORS_ALLOWED_METHODS: ${CORS_ALLOWED_METHODS:-GET,POST,PUT,DELETE,OPTIONS}
      CORS_ALLOWED_HEADERS: ${CORS_ALLOWED_HEADERS:-Accept,Authorization,Content-Type,X-CSRF-Token}
      CORS_ALLOW_CREDENTIALS: ${CORS_ALLOW_CREDENTIALS:-true}

      # Storage
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-s3}
      STORAGE_LOCAL_PATH: /data/uploads

      # S3/Compatible Storage
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}
      S3_USE_SSL: ${S3_USE_SSL:-true}

      # IPFS
      IPFS_ENABLED: ${IPFS_ENABLED:-true}
      IPFS_API_URL: http://ipfs:5001
      IPFS_GATEWAY_URL: ${IPFS_GATEWAY_URL:-https://ipfs.io}
      IPFS_PINATA_JWT: ${IPFS_PINATA_JWT}
      IPFS_INFURA_PROJECT_ID: ${IPFS_INFURA_PROJECT_ID}
      IPFS_INFURA_PROJECT_SECRET: ${IPFS_INFURA_PROJECT_SECRET}

      # ClamAV
      CLAMAV_HOST: clamav
      CLAMAV_PORT: 3310
      CLAMAV_TIMEOUT: ${CLAMAV_TIMEOUT:-30s}

      # Image Processing
      IMAGE_MAX_FILE_SIZE: ${IMAGE_MAX_FILE_SIZE:-10485760}
      IMAGE_ALLOWED_TYPES: ${IMAGE_ALLOWED_TYPES:-image/jpeg,image/png,image/webp,image/gif}
      IMAGE_QUALITY: ${IMAGE_QUALITY:-85}
      IMAGE_STRIP_METADATA: ${IMAGE_STRIP_METADATA:-true}

      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS:-100}
      RATE_LIMIT_WINDOW: ${RATE_LIMIT_WINDOW:-1m}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}

      # Observability
      METRICS_ENABLED: ${METRICS_ENABLED:-true}
      METRICS_PORT: 9090
      TRACING_ENABLED: ${TRACING_ENABLED:-false}
      TRACING_ENDPOINT: ${TRACING_ENDPOINT}

      # Environment
      ENVIRONMENT: production
    volumes:
      # Writable temp directory for uploads
      - upload_tmp:/tmp:rw
      # Read-only uploads (if using local storage)
      - upload_data:/data/uploads:rw
    tmpfs:
      - /tmp/processing:uid=10001,gid=10001,mode=1777,size=512m
    networks:
      - frontend
      - backend
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      clamav:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================================================
  # Background Worker
  # ============================================================================
  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile.worker
    container_name: goimg-worker
    restart: unless-stopped
    user: "10001:10001"
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    environment:
      # Database (same as API)
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_NAME: ${DB_NAME}
      DB_SSL_MODE: ${DB_SSL_MODE:-require}

      # Redis
      REDIS_URL: redis://redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # Worker Settings
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-10}
      WORKER_QUEUES: ${WORKER_QUEUES:-critical:6,default:3,low:1}

      # Storage (same as API)
      STORAGE_PROVIDER: ${STORAGE_PROVIDER:-s3}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_BUCKET: ${S3_BUCKET}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      S3_SECRET_KEY: ${S3_SECRET_KEY}

      # IPFS
      IPFS_ENABLED: ${IPFS_ENABLED:-true}
      IPFS_API_URL: http://ipfs:5001
      IPFS_PINATA_JWT: ${IPFS_PINATA_JWT}

      # ClamAV
      CLAMAV_HOST: clamav
      CLAMAV_PORT: 3310

      # Image Processing
      IMAGE_QUALITY: ${IMAGE_QUALITY:-85}
      IMAGE_STRIP_METADATA: ${IMAGE_STRIP_METADATA:-true}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}

      ENVIRONMENT: production
    volumes:
      # Writable temp directory for processing
      - worker_tmp:/tmp:rw
    tmpfs:
      - /tmp/processing:uid=10001,gid=10001,mode=1777,size=1g
    networks:
      - backend
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      clamav:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pgrep", "-f", "worker"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 1G

  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: goimg-postgres
    restart: unless-stopped
    user: postgres
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
      # Performance tuning
      POSTGRES_MAX_CONNECTIONS: ${DB_MAX_CONNECTIONS:-100}
      POSTGRES_SHARED_BUFFERS: ${DB_SHARED_BUFFERS:-256MB}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${DB_EFFECTIVE_CACHE_SIZE:-1GB}
      POSTGRES_WORK_MEM: ${DB_WORK_MEM:-4MB}
      POSTGRES_MAINTENANCE_WORK_MEM: ${DB_MAINTENANCE_WORK_MEM:-64MB}
    volumes:
      - postgres_data:/var/lib/postgresql/data:rw
      - postgres_backups:/backups:rw
      - /var/run/postgresql:rw,tmpfs
    tmpfs:
      - /tmp:uid=70,gid=70,mode=1777,size=256m
      - /run:uid=70,gid=70,mode=1777,size=64m
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ============================================================================
  # Redis Cache/Queue
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: goimg-redis
    restart: unless-stopped
    user: redis
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --appendfsync everysec
      --auto-aof-rewrite-percentage 100
      --auto-aof-rewrite-min-size 64mb
      --maxmemory ${REDIS_MAX_MEMORY:-512mb}
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --dir /data
      --loglevel notice
    volumes:
      - redis_data:/data:rw
    tmpfs:
      - /tmp:uid=999,gid=999,mode=1777,size=64m
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 768M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ============================================================================
  # ClamAV Antivirus Scanner
  # ============================================================================
  clamav:
    image: clamav/clamav:1.3
    container_name: goimg-clamav
    restart: unless-stopped
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    environment:
      CLAMAV_NO_FRESHCLAMD: "false"
      FRESHCLAM_CHECKS: ${CLAMAV_UPDATE_FREQUENCY:-24}
    volumes:
      - clamav_data:/var/lib/clamav:rw
    tmpfs:
      - /tmp:uid=100,gid=101,mode=1777,size=2g
      - /run/clamav:uid=100,gid=101,mode=1777,size=64m
      - /var/lock:uid=100,gid=101,mode=1777,size=16m
    networks:
      - backend
    healthcheck:
      test: ["CMD", "/usr/local/bin/clamdcheck.sh"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 300s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '0.5'
          memory: 1.5G

  # ============================================================================
  # IPFS Node (Optional - for decentralized storage)
  # ============================================================================
  ipfs:
    image: ipfs/kubo:v0.25.0
    container_name: goimg-ipfs
    restart: unless-stopped
    user: "1000:1000"
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    environment:
      IPFS_PROFILE: server
      IPFS_PATH: /data/ipfs
    volumes:
      - ipfs_data:/data/ipfs:rw
      - ipfs_staging:/export:rw
    tmpfs:
      - /tmp:uid=1000,gid=1000,mode=1777,size=512m
    command: ["daemon", "--migrate=true", "--enable-gc", "--routing=dhtclient"]
    networks:
      - backend
    # Not exposed to public - only internal API access
    expose:
      - "5001"
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "ipfs id || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    profiles:
      - ipfs

  # ============================================================================
  # Nginx Reverse Proxy
  # ============================================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: goimg-nginx
    restart: unless-stopped
    user: "101:101"
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_cache:/var/cache/nginx:rw
      - nginx_logs:/var/log/nginx:rw
    tmpfs:
      - /tmp:uid=101,gid=101,mode=1777,size=64m
      - /var/run:uid=101,gid=101,mode=1777,size=16m
    networks:
      - frontend
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_ROOT:-/var/lib/goimg}/postgres
  postgres_backups:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_ROOT:-/var/lib/goimg}/backups
  redis_data:
    driver: local
  clamav_data:
    driver: local
  ipfs_data:
    driver: local
  ipfs_staging:
    driver: local
  upload_tmp:
    driver: local
  upload_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_ROOT:-/var/lib/goimg}/uploads
  worker_tmp:
    driver: local
  nginx_cache:
    driver: local
  nginx_logs:
    driver: local

# ==============================================================================
# Networks
# ==============================================================================
networks:
  # Frontend network - nginx <-> api only
  frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

  # Backend network - internal services
  backend:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/24
