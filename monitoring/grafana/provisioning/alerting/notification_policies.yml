apiVersion: 1

# Notification Policies for Security Alerts
# These policies route alerts to appropriate contact points based on severity and labels
# Policies are evaluated top-to-bottom; first match wins

policies:
  - orgId: 1
    receiver: security-team-email
    group_by:
      - alertname
      - severity
      - category
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 4h

    # Mute timing (optional - prevents alerts during maintenance windows)
    # mute_time_intervals:
    #   - maintenance-window

    routes:
      # Route 1: Critical alerts (P0) - Malware and immediate threats
      # Send to: PagerDuty (page on-call), Slack, Email
      - receiver: security-pagerduty
        matchers:
          - severity = critical
          - priority = P0
        group_by:
          - alertname
        group_wait: 10s
        group_interval: 1m
        repeat_interval: 30m
        continue: true  # Continue to other routes

      # Route 2: Critical alerts (P0) also to Slack for visibility
      - receiver: security-slack-channel
        matchers:
          - severity = critical
          - priority = P0
        group_wait: 10s
        group_interval: 1m
        repeat_interval: 1h
        continue: true

      # Route 3: High priority alerts (P1) - Privilege escalation
      # Send to: PagerDuty, Slack
      - receiver: security-pagerduty
        matchers:
          - severity = critical
          - priority = P1
        group_wait: 30s
        group_interval: 2m
        repeat_interval: 1h
        continue: true

      # Route 4: High priority also to Slack
      - receiver: security-slack-channel
        matchers:
          - severity = critical
          - priority = P1
        group_wait: 30s
        group_interval: 2m
        repeat_interval: 2h
        continue: true

      # Route 5: Warning severity - Authentication failures, rate limits
      # Send to: Slack, Email (no page)
      - receiver: security-slack-channel
        matchers:
          - severity = warning
        group_wait: 1m
        group_interval: 5m
        repeat_interval: 4h
        continue: true

      # Route 6: Attack patterns (brute force, enumeration)
      # Send to: Slack, Email
      - receiver: security-slack-channel
        matchers:
          - subcategory = attack_pattern
        group_wait: 2m
        group_interval: 10m
        repeat_interval: 6h
        continue: true

      # Route 7: All security alerts to webhook (SIEM integration)
      - receiver: security-webhook
        matchers:
          - category = security
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 24h
        continue: false  # Don't continue to default

# Mute timings (optional - define maintenance windows)
# mute_time_intervals:
#   - name: maintenance-window
#     time_intervals:
#       # Every Saturday 2-4 AM UTC
#       - times:
#           - start_time: '02:00'
#             end_time: '04:00'
#         weekdays: ['saturday']
