# Production Monitoring Setup

This directory contains production monitoring configuration for goimg-datalayer using Prometheus and Grafana.

## Directory Structure

```
monitoring/
├── prometheus/
│   └── prometheus.yml          # Prometheus scrape configuration
├── grafana/
│   ├── dashboards/             # Pre-configured Grafana dashboards
│   │   ├── application_overview.json
│   │   ├── image_gallery.json
│   │   ├── security_events.json
│   │   └── infrastructure_health.json
│   └── provisioning/           # Grafana auto-provisioning configs
│       ├── dashboards/
│       │   └── dashboards.yml
│       └── datasources/
│           └── prometheus.yml
└── README.md
```

## Quick Start

### 1. Start Production Stack

```bash
cd /home/user/goimg-datalayer
docker-compose -f docker/docker-compose.prod.yml up -d
```

### 2. Access Services

- **Grafana**: http://localhost:3000
  - Default credentials: `admin` / `admin` (change on first login)
- **Prometheus**: http://localhost:9091
- **API Server**: http://localhost:8080
- **API Metrics**: http://localhost:9090/metrics

### 3. View Dashboards

Grafana dashboards are automatically provisioned on startup. Navigate to:
- **Dashboards** → **goimg** folder

## Available Dashboards

### 1. Application Overview
**File**: `application_overview.json`

Monitors overall application health and performance:
- Request rate (requests/second)
- Error rate (4xx, 5xx responses)
- Request latency (P50, P95, P99)
- Active HTTP connections
- Requests by status code

**Key Metrics**:
- `http_requests_total` - Total HTTP requests
- `http_request_duration_seconds` - Request latency histogram
- `http_server_active_connections` - Current active connections

### 2. Image Gallery Metrics
**File**: `image_gallery.json`

Tracks image processing and storage:
- Image upload rate (success/failed)
- Image processing time (P50, P95, P99)
- Storage usage
- Image variants generated by type
- Image size distribution
- Images by format (pie chart)
- IPFS pin duration

**Key Metrics**:
- `image_uploads_total` - Image upload counter
- `image_processing_duration_seconds` - Processing time histogram
- `storage_used_bytes` - Total storage consumed
- `image_variants_generated_total` - Variant generation counter
- `ipfs_pin_duration_seconds` - IPFS pinning time

### 3. Security Events
**File**: `security_events.json`

Monitors security-related events:
- Authentication failures (invalid credentials, expired/invalid tokens)
- Rate limit violations by endpoint and IP
- Malware detections (with alert configured)
- Authorization failures by resource/action
- Top failed auth IPs (table)
- Auth failure reasons (pie chart)
- Suspicious activity rate

**Key Metrics**:
- `auth_failures_total` - Authentication failure counter
- `rate_limit_violations_total` - Rate limit hit counter
- `malware_detections_total` - Malware detection counter
- `authorization_failures_total` - Authorization failure counter
- `suspicious_activity_total` - Suspicious activity counter

**Alerts**:
- Malware Detection Alert: Triggers if malware detected in last 5 minutes

### 4. Infrastructure Health
**File**: `infrastructure_health.json`

Monitors infrastructure components:
- Database connection pool (active, idle, max)
- Database query duration (P50, P95, P99)
- Redis connections (connected, blocked clients)
- ClamAV health status (UP/DOWN gauge)
- Memory usage (API and Worker)
- CPU usage (API and Worker)
- Go runtime memory (heap allocated, system memory)
- Go goroutines (API and Worker)
- Redis cache hit rate

**Key Metrics**:
- `db_connection_pool_*` - Database connection metrics
- `db_query_duration_seconds` - Query latency histogram
- `redis_connected_clients` - Redis client count
- `clamav_up` - ClamAV health check
- `go_memstats_*` - Go runtime memory metrics
- `go_goroutines` - Active goroutine count
- `redis_keyspace_hits_total` / `redis_keyspace_misses_total` - Cache metrics

## Required Prometheus Metrics

For the dashboards to work correctly, your Go application must expose these metrics on the `/metrics` endpoint (port 9090):

### HTTP Metrics
```go
http_requests_total{service, method, path, status}
http_request_duration_seconds_bucket{service}
http_server_active_connections{service}
```

### Image Processing Metrics
```go
image_uploads_total{service, status, format}
image_processing_duration_seconds_bucket{service}
storage_used_bytes{service}
image_variants_generated_total{service, variant_type}
image_size_bytes_bucket{service}
ipfs_pin_duration_seconds_bucket{service}
```

### Security Metrics
```go
auth_failures_total{service, reason, ip}
rate_limit_violations_total{service, endpoint, ip}
malware_detections_total{service}
authorization_failures_total{service, resource, action}
suspicious_activity_total{service, activity_type}
```

### Infrastructure Metrics
```go
db_connection_pool_active{service}
db_connection_pool_idle{service}
db_connection_pool_max{service}
db_query_duration_seconds_bucket{service}
redis_connected_clients{service}
redis_blocked_clients{service}
clamav_up{service}
redis_keyspace_hits_total{service}
redis_keyspace_misses_total{service}
```

### Go Runtime Metrics (automatically exposed by Prometheus client)
```go
go_memstats_alloc_bytes{service}
go_memstats_sys_bytes{service}
go_goroutines{service}
node_memory_MemAvailable_bytes{service}
node_memory_MemTotal_bytes{service}
node_cpu_seconds_total{service, mode}
```

## Prometheus Configuration

The Prometheus configuration (`prometheus/prometheus.yml`) includes:
- **Scrape interval**: 15 seconds
- **Evaluation interval**: 15 seconds
- **Retention**: 30 days (configured in docker-compose.prod.yml)
- **Target**: `api:9090` (goimg-api service metrics endpoint)

## Network Architecture

The production Docker Compose uses network segmentation:
- **frontend** (172.20.0.0/24): Public-facing services (API, Grafana)
- **backend** (172.21.0.0/24): Internal services (API, Worker, Redis, IPFS, Prometheus)
- **database** (172.22.0.0/24): Database isolated network (internal only)

## Resource Limits

All services have resource limits configured:
- **API**: 2 CPU, 2GB RAM
- **Worker**: 4 CPU, 4GB RAM
- **Postgres**: 2 CPU, 2GB RAM
- **Redis**: 1 CPU, 1GB RAM
- **ClamAV**: 2 CPU, 4GB RAM
- **IPFS**: 2 CPU, 2GB RAM
- **Prometheus**: 1 CPU, 2GB RAM
- **Grafana**: 1 CPU, 1GB RAM

## Logging Configuration

All services use JSON file logging with:
- **Max size**: 10MB per file
- **Max files**: 3 (rotation)
- **Driver**: json-file

## Health Checks

All services include health checks:
- **API**: HTTP check on `/health` endpoint
- **Postgres**: `pg_isready` command
- **Redis**: `redis-cli ping`
- **ClamAV**: `clamdcheck.sh`
- **IPFS**: `ipfs id` command
- **Prometheus**: HTTP check on `/-/healthy`
- **Grafana**: HTTP check on `/api/health`

## Customization

### Adding New Dashboards

1. Create dashboard JSON in `grafana/dashboards/`
2. Restart Grafana container: `docker-compose -f docker/docker-compose.prod.yml restart grafana`
3. Dashboard will be auto-imported

### Modifying Prometheus Scrape Targets

1. Edit `prometheus/prometheus.yml`
2. Restart Prometheus: `docker-compose -f docker/docker-compose.prod.yml restart prometheus`

### Environment Variables

Set these in production:
- `DB_PASSWORD` - PostgreSQL password
- `GRAFANA_ADMIN_USER` - Grafana admin username
- `GRAFANA_ADMIN_PASSWORD` - Grafana admin password

Example:
```bash
export DB_PASSWORD="secure_password_here"
export GRAFANA_ADMIN_PASSWORD="secure_grafana_password"
docker-compose -f docker/docker-compose.prod.yml up -d
```

## Troubleshooting

### Dashboards not appearing
```bash
# Check Grafana logs
docker logs goimg-grafana

# Verify provisioning directory is mounted
docker exec goimg-grafana ls -la /etc/grafana/provisioning/dashboards
docker exec goimg-grafana ls -la /var/lib/grafana/dashboards
```

### No metrics in Prometheus
```bash
# Check Prometheus targets
curl http://localhost:9091/api/v1/targets

# Verify API metrics endpoint
curl http://localhost:9090/metrics

# Check Prometheus logs
docker logs goimg-prometheus
```

### Connection refused errors
```bash
# Verify network connectivity
docker exec goimg-prometheus ping -c 3 api

# Check service status
docker-compose -f docker/docker-compose.prod.yml ps
```

## Maintenance

### Backup Grafana Dashboards
```bash
docker exec goimg-grafana grafana-cli admin export-dashboards --outputDir=/tmp/backup
docker cp goimg-grafana:/tmp/backup ./grafana-backup
```

### Clean Up Old Metrics
Prometheus automatically cleans up data older than 30 days (retention period).

### Update Services
```bash
docker-compose -f docker/docker-compose.prod.yml pull
docker-compose -f docker/docker-compose.prod.yml up -d
```

## Security Considerations

1. **Change default passwords** for Grafana on first login
2. **Use strong DB passwords** via environment variables
3. **Enable HTTPS** in production (use reverse proxy like Nginx)
4. **Restrict Grafana access** using firewall rules or authentication
5. **Monitor security events dashboard** regularly for suspicious activity

## Next Steps

1. Implement Prometheus metrics in your Go application
2. Configure alerting rules in Prometheus
3. Set up Alertmanager for alert notifications
4. Add custom dashboards for specific business metrics
5. Configure Grafana SMTP for dashboard sharing
