# Pre-commit hooks for goimg-datalayer
#
# Installation:
#   pip install pre-commit
#   pre-commit install
#
# Run manually:
#   pre-commit run --all-files
#
# Update hooks to latest versions:
#   pre-commit autoupdate

default_language_version:
  python: python3.11

repos:
  # ==========================================================================
  # General file checks
  # ==========================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      # Prevent giant files from being committed
      - id: check-added-large-files
        args: ['--maxkb=1000']
        exclude: |
          (?x)^(
            tests/fixtures/.*|
            docs/.*\.pdf|
            .*\.jpg|
            .*\.png|
            .*\.gif
          )$

      # Check for files that would conflict in case-insensitive filesystems
      - id: check-case-conflict

      # Check for merge conflicts
      - id: check-merge-conflict

      # Check for debugger imports and py37+ breakpoint() calls
      - id: debug-statements

      # Detect private keys
      - id: detect-private-key

      # Check for symlinks which do not point to anything
      - id: check-symlinks

      # Check for files that contain merge conflict strings
      - id: check-merge-conflict

      # Ensure files end with a newline
      - id: end-of-file-fixer
        exclude: |
          (?x)^(
            .*\.pb\.go|
            .*\.gen\.go
          )$

      # Trim trailing whitespace
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: |
          (?x)^(
            .*\.pb\.go|
            .*\.gen\.go
          )$

      # Check JSON syntax
      - id: check-json
        exclude: |
          (?x)^(
            tests/e2e/postman/.*\.json
          )$

      # Check YAML syntax
      - id: check-yaml
        args: [--allow-multiple-documents]

      # Check TOML syntax
      - id: check-toml

      # Check XML syntax
      - id: check-xml

      # Ensure files are either ASCII or UTF-8
      - id: mixed-line-ending
        args: [--fix=lf]

  # ==========================================================================
  # Go specific hooks
  # ==========================================================================
  - repo: https://github.com/tekwizely/pre-commit-golang
    rev: v1.0.0-rc.1
    hooks:
      # Run go fmt
      - id: go-fmt
        args: [-w, -s]

      # Run go vet
      - id: go-vet
        args: [./...]

      # Run go imports
      - id: go-imports
        args: [-w, -local, github.com/yegamble/goimg-datalayer]

      # Run go mod tidy
      - id: go-mod-tidy

      # Run go mod verify
      - id: go-mod-verify

      # NOTE: go-build-mod and go-test-mod are intentionally disabled here
      # They are too slow for pre-commit hooks and are run in CI instead
      # If you want to run them locally, use: make build && make test

      # Run golangci-lint
      - id: golangci-lint-mod
        args: [--config=.golangci.yml, --timeout=5m]

  # ==========================================================================
  # Secret detection
  # ==========================================================================
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.19.2
    hooks:
      - id: gitleaks
        args: [--no-banner]

  # ==========================================================================
  # Go vulnerability scanning
  # ==========================================================================
  - repo: local
    hooks:
      - id: govulncheck
        name: Go Vulnerability Check
        entry: bash -c 'command -v govulncheck >/dev/null 2>&1 || go install golang.org/x/vuln/cmd/govulncheck@latest; govulncheck ./...'
        language: system
        files: go\.(mod|sum)$
        pass_filenames: false

  # ==========================================================================
  # Security checks
  # ==========================================================================
  - repo: https://github.com/securego/gosec
    rev: v2.21.4
    hooks:
      - id: gosec
        args: [./...]
        exclude: |
          (?x)^(
            .*_test\.go|
            tests/.*
          )$

  # ==========================================================================
  # YAML linting
  # ==========================================================================
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.35.1
    hooks:
      - id: yamllint
        args: [-c=.yamllint.yml]
        types: [yaml]

  # ==========================================================================
  # Markdown linting
  # ==========================================================================
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.42.0
    hooks:
      - id: markdownlint
        args: [--fix]
        exclude: |
          (?x)^(
            CHANGELOG\.md|
            \.github/.*\.md
          )$

  # ==========================================================================
  # Shell script linting
  # ==========================================================================
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.10.0.1
    hooks:
      - id: shellcheck
        args: [-x]

  # ==========================================================================
  # Dockerfile linting
  # ==========================================================================
  - repo: https://github.com/hadolint/hadolint
    rev: v2.12.1-beta
    hooks:
      - id: hadolint-docker
        args: [--ignore, DL3018, --ignore, DL3027]

  # ==========================================================================
  # Commit message linting (Conventional Commits)
  # ==========================================================================
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v3.4.0
    hooks:
      - id: conventional-pre-commit
        stages: [commit-msg]
        args: [--strict]

  # ==========================================================================
  # OpenAPI validation
  # ==========================================================================
  - repo: https://github.com/python-jsonschema/check-jsonschema
    rev: 0.29.3
    hooks:
      - id: check-jsonschema
        name: Validate OpenAPI Spec
        files: ^api/openapi/.*\.ya?ml$
        args:
          - --schemafile
          - https://raw.githubusercontent.com/OAI/OpenAPI-Specification/main/schemas/v3.1/schema.json

  # ==========================================================================
  # SQL linting
  # ==========================================================================
  - repo: https://github.com/sqlfluff/sqlfluff
    rev: 3.2.5
    hooks:
      - id: sqlfluff-lint
        args: [--dialect, postgres]
        files: \.(sql|sql\.j2)$
        exclude: |
          (?x)^(
            vendor/.*
          )$

      - id: sqlfluff-fix
        args: [--dialect, postgres]
        files: \.(sql|sql\.j2)$
        exclude: |
          (?x)^(
            vendor/.*
          )$

# Configuration for specific hooks
ci:
  # Skip these hooks in CI (they're run in GitHub Actions)
  skip:
    - golangci-lint-mod
    - govulncheck
    - gosec

  # Autoupdate schedule (weekly)
  autoupdate_schedule: weekly

  # Autoupdate commit message
  autoupdate_commit_msg: 'chore: update pre-commit hooks'
